<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPK University AI Study Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            padding: 1rem;
        }
        .text-gradient {
            background-image: linear-gradient(45deg, #1d4ed8, #4f46e5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .chat-container {
            width: 100%;
            max-width: 600px;
            height: 100%;
            max-height: 800px;
            background-color: #ffffff;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            word-wrap: break-word;
        }
        .user-message {
            background-color: #4f46e5;
            color: #ffffff;
            align-self: flex-end;
            border-bottom-right-radius: 0.5rem;
        }
        .ai-message {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.5rem;
        }
        .chat-input {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        .chat-input input {
            flex-grow: 1;
            border-radius: 9999px;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
        .chat-input input:disabled {
            background-color: #f9fafb;
            cursor: not-allowed;
        }
        .chat-input button {
            background-color: #4f46e5;
            color: #ffffff;
            border-radius: 9999px;
            padding: 0.5rem 1.5rem;
            font-weight: 600;
            transition: background-color 0.3s;
            border: none;
            cursor: pointer;
        }
        .chat-input button:hover:not(:disabled) {
            background-color: #6366f1;
        }
        .chat-input button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .loading-dots {
            opacity: 0.6;
            font-style: italic;
        }
    </style>
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            AI Study Coach
        </div>
        <div class="chat-messages" id="chat-messages">
            </div>
        <div class="chat-input">
            <input type="text" id="user-input" placeholder="Ask a study question, request a quiz, or get help with any topic...">
            <button id="send-button">Send</button>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://zgcegkmqfgznbpdplscz.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnY2Vna21xZmd6bmJwZHBsc2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk0MDcxNTgsImV4cCI6MjA2NDk4MzE1OH0.RCtAqfgz7aqjG-QWiOqFBCG5xg2Rok9T4tbyGQMnCm8'
        );

        document.addEventListener('DOMContentLoaded', () => {
            const messagesContainer = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            let isLoading = false;

            // Generate a simple session ID for this chat
            const sessionId = 'html-session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            const userId = 'anonymous-' + Math.random().toString(36).substr(2, 9);

            // Initial AI message to start the conversation
            addMessage('ai', "Hi there! I'm your AI Study Coach. How can I help you learn today? Try asking me about any topic, request a quiz, or ask for study help!");

            // Function to add messages to the chat interface
            function addMessage(sender, text) {
                const messageElement = document.createElement('div');
                messageElement.className = `message-bubble ${sender}-message`;
                messageElement.textContent = text;
                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Function to show loading state
            function showLoading() {
                const loadingElement = document.createElement('div');
                loadingElement.className = 'message-bubble ai-message loading-dots';
                loadingElement.id = 'loading-message';
                loadingElement.textContent = 'AI is thinking...';
                messagesContainer.appendChild(loadingElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Function to remove loading state
            function hideLoading() {
                const loadingElement = document.getElementById('loading-message');
                if (loadingElement) {
                    loadingElement.remove();
                }
            }

            // Function to get AI response from Supabase backend
            async function getAIResponse(message) {
                try {
                    const { data, error } = await supabaseClient.functions.invoke('ai-study-chat', {
                        body: {
                            message: message,
                            userId: userId,
                            sessionId: sessionId,
                            chatMode: 'general', // Use general mode for public access
                            voiceActive: false,
                            metadata: {
                                timestamp: new Date().toISOString(),
                                userAgent: navigator.userAgent,
                                sessionLength: Math.floor(messagesContainer.children.length / 2),
                                ragEnabled: true,
                                enhancedKnowledgeRetrieval: true
                            }
                        }
                    });

                    if (error) {
                        console.error('AI function error:', error);
                        return "I apologize, but I'm having trouble connecting to my knowledge base right now. Please try again in a moment.";
                    }

                    return data?.response || "I'm here to help with your learning! What would you like to explore?";
                } catch (error) {
                    console.error('Error calling AI function:', error);
                    return "I'm having trouble processing your request right now. Please try again.";
                }
            }

            // Event listener for the send button
            sendButton.addEventListener('click', async () => {
                if (isLoading) return;
                
                const message = userInput.value.trim();
                if (message) {
                    isLoading = true;
                    sendButton.disabled = true;
                    userInput.disabled = true;
                    sendButton.textContent = 'Sending...';
                    
                    addMessage('user', message);
                    userInput.value = '';
                    showLoading();

                    try {
                        const aiResponse = await getAIResponse(message);
                        hideLoading();
                        addMessage('ai', aiResponse);
                    } catch (error) {
                        hideLoading();
                        addMessage('ai', "I'm sorry, something went wrong. Please try again.");
                    } finally {
                        isLoading = false;
                        sendButton.disabled = false;
                        userInput.disabled = false;
                        sendButton.textContent = 'Send';
                        userInput.focus();
                    }
                }
            });

            // Event listener for the Enter key
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !isLoading) {
                    sendButton.click();
                }
            });

            // Focus input on load
            userInput.focus();
        });
    </script>
</body>
</html>